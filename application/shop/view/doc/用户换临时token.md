
# 临时token机制概述

~~~
临时token机制说明
客户端（含web，安卓，苹果）每次 http 请求在 header 中均带上这个临时token，没有就不传。
主要是客户端传给服务器，偶尔服务端传给客户端。
原先用作密码的token是不在头部中传送的。

服务端传给客户端的方式是 在header 中返回的。基本不用json
如果服务端传给客户端新的token，则客户端需立即替换，并在下次请求中传新的值（不需调用我的接口）。
如果网络断也不用担心，因为临近token有效期时，每次服务器都会返回新值，不是只有一次。

每次登录或新注册用户，临时token都会在 header 里生成。


服务器可能会在所有请求时的json中返回特定code，并同时在header中也返回CODE。
  -205       // ip进入ip黑名单
  -206       // token错误，
  -207       // token过于频繁，。
-206 情况：web客户端，页面切换到登录页面或使用接口换新token，看情况自定。  app客户端，使用换临时token的下面接口得到新token。
-207 情况：web客户端，页面切换到人机识别页面。app客户端，页面切换到登录页面。


接口调用说明：
我每次返回的头部中，如果带有Cache-Contro1，则客户端立刻替换，不调接口。
如果我返回的json中有特定的错误码，则客户端调用我的接口，来得到新的临时token，并立即替换。


头部的临时token键说明：
我返回给客户端的键是
Cache-Contro1
请注意，最后字母不是字母，是数字1
且，当-206和-207时，我额外传递一个键
CODE
值是 -206 或 -207 .

而客户端传给我的头部临时token的键是
Temp-Token


~~~


## 用户换临时token

功能：

1. 用户换临时token ，主要是用户遇到code 为 -206 的情况下，需要调用此接口。     
1. web和app客户端均有可能调用此接口。      

~~~
/user/login/check
~~~
~~~
POST
~~~

| 请求参数字段        | 请求参数含义  |
| -------- |:------|
| uid     | 当前用户uid |
| token     | 当前用户token，是原先用作密码的token |


| 返回字段        | 类型 |含义  |
| -------- |:------|:------|
| result     | string | 被base64函数编码过的一个token，客户端取得后需自行反解一下。 |


## 轮询更换临时token的接口
功能：

1. 主要用于安卓轮询更新头部token。  
1. 要求轮询间隔时间小于10分钟，最多9分钟。  
1. 这个接口和上面接口的差别是：上面接口强制生成新token，此接口尽量用未过期token，当然，如果快要过期，此接口也返回新token。          
1. 临时token依然放在请求的header中。

~~~
/user/login/polling
~~~
~~~
GET
~~~

| 请求参数字段        | 请求参数含义  |
| -------- |:------|
| token    | 得是密码token，就是老早那个token |


| 返回字段        | 类型 |含义  |
| -------- |:------|:------|
| result     | string | 被base64函数编码过的一个token，客户端取得后需自行反解一下。 |



## 请求人机页面图片

~~~
/user/login/man_machine_recognition_pic
~~~
~~~
GET
~~~

功能：

1. 客户端请求一个人机页面的图片。  


| 请求参数字段        | 请求参数含义  |
| -------- |:------|
| token     | 当前用户token |
| type     | 默认1，可不传 |


| 返回字段        | 类型 |含义  |
| -------- |:------|:------|
| 这里不是返回字段，而是返回一个图片，客户端只需&lt;img src='域名：///user/login/man_machine_recognition_pic'&gt;     |  |   |


## 上传人机页面检查结果

~~~
/user/login/man_machine_recognition_check
~~~
~~~
POST
~~~

功能：

1. 客户端填写结果，并传给服务器校验。  


| 请求参数字段         | 请求参数含义  |
| --------  |:------|
| token     | 当前用户token |
| type     | 默认1，可不传 |
| cal_result     | 用户计算的结果 |


| 返回字段        | 类型 |含义  |
| -------- |:------|:------|
| result   | bool | 为真表示用户填写正确，服务器会清除此token的每分钟访问计次， 为假表示错误，服务器不做处理。  |





















